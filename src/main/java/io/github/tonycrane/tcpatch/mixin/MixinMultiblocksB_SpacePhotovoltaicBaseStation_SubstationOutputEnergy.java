package io.github.tonycrane.tcpatch.mixin;

import com.gregtechceu.gtceu.api.machine.MultiblockMachineDefinition;
import com.gregtechceu.gtceu.api.machine.multiblock.PartAbility;
import com.gregtechceu.gtceu.api.pattern.FactoryBlockPattern;
import com.gregtechceu.gtceu.api.pattern.Predicates;
import com.gregtechceu.gtceu.api.pattern.TraceabilityPredicate;
import com.gregtechceu.gtceu.common.data.GTBlocks;
import com.gregtechceu.gtceu.utils.memoization.GTMemoizer;

import net.minecraft.resources.ResourceLocation;
import net.minecraft.world.level.block.Block;
import net.minecraft.world.level.block.Blocks;
import net.minecraftforge.registries.ForgeRegistries;
import org.spongepowered.asm.mixin.Final;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.Pseudo;
import org.spongepowered.asm.mixin.Shadow;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
import org.spongepowered.asm.mixin.Unique;

/**
 * CTNH-Core: Allow using Power Substation Dynamo Hatches in SPACEPHOTOVOLTAICBASESTATION.
 *
 * Most stable approach (same style as {@link MixinMultiblocksB_CombinedVDF_PatternFix}):
 * fully rebuild the target definition's patternFactory after registration (<clinit> TAIL),
 * changing only the 'B' predicate to include SUBSTATION_OUTPUT_ENERGY.
 */
@Pseudo
@Mixin(targets = "io.github.cpearl0.ctnhcore.registry.machines.multiblock.MultiblocksB", remap = false)
public abstract class MixinMultiblocksB_SpacePhotovoltaicBaseStation_SubstationOutputEnergy {

    @Unique
    private static boolean tcpatch$spacePvBaseStation$patched;

    @Shadow
    @Final
    private static MultiblockMachineDefinition SPACEPHOTOVOLTAICBASESTATION;

    @Inject(method = "<clinit>", at = @At("TAIL"))
    private static void tcpatch$spacePvBaseStation$patchPattern(CallbackInfo ci) {
        if (tcpatch$spacePvBaseStation$patched) return;
        tcpatch$spacePvBaseStation$patched = true;

        var definition = SPACEPHOTOVOLTAICBASESTATION;
        if (definition == null) return;

        definition.setPatternFactory(GTMemoizer.memoize(() -> FactoryBlockPattern.start()
                .aisle("A############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############BCDCCCDCB##############", "#############BCDCECDCB##############", "#############BCDCCCDCB##############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "##############CDDDDDC###############", "#############F#######F##############", "#############C###G###C##############", "#############F##H#H##F##############", "##############CDDDDDC###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "##############CCCCCCC###############", "#############F#######F##############", "############F#########F#############", "############C####G####C#############", "############F###H#H###F#############", "#############F#######F##############", "##############CCCCCCC###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "##############FFFFFFF###############", "#############C#######C##############", "############F#########F#############", "###########F###########F############", "###########C#####G#####C############", "###########F####H#H####F############", "############F#########F#############", "#############C#######C##############", "##############FFFFFFF###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "##############FFFFFFF###############", "#############F#######F##############", "############C#########C#############", "###########F###########F############", "##########F#############F###########", "##########C######G######C###########", "##########F#####H#H#####F###########", "###########F###########F############", "############C#########C#############", "#############F#######F##############", "##############FFFFFFF###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "##############FFFFFFF###############", "#############F#######F##############", "############F#########F#############", "###########C###########C############", "##########F#############F###########", "#########F###############F##########", "#########C#######G#######C##########", "#########F######H#H######F##########", "##########F#############F###########", "###########C###########C############", "############F#########F#############", "#############F#######F##############", "##############FFFFFFF###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############B#######B##############", "#############BFFFFFFFB##############", "#############F#######F##############", "############F#########F#############", "###########F###########F############", "##########C#############C###########", "#########F###############F##########", "########F#################F#########", "########C########G########C#########", "########F#######H#H#######F#########", "#########F###############F##########", "##########C#############C###########", "###########F###########F############", "############F#########F#############", "#############F#######F##############", "##############FFFFFFF###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "##############FFFFFFF###############", "#############F#######F##############", "############F#########F#############", "###########F###########F############", "##########F#############F###########", "#########C###############C##########", "########F#################F#########", "#######F###################F########", "#######C#########G#########C########", "#######F########H#H########F########", "########F#################F#########", "#########C###############C##########", "##########F#############F###########", "###########F###########F############", "############F#########F#############", "#############F#######F##############", "##############FFFFFFF###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "##############FFFFFFF###############", "#############F#######F##############", "############F#########F#############", "###########F###########F############", "##########F#############F###########", "#########F###############F##########", "########C#################C#########", "#######F###################F########", "######F#####################F#######", "######C##########G##########C#######", "######F#########H#H#########F#######", "#######F###################F########", "########C#################C#########", "#########F###############F##########", "##########F#############F###########", "###########F###########F############", "############F#########F#############", "#############F#######F##############", "##############FFFFFFF###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "##############FFFFFFF###############", "#############F#######F##############", "############F#########F#############", "###########F###########F############", "##########F#############F###########", "#########F###############F##########", "########F#################F#########", "#######C###################C########", "######F#####################F#######", "#####F#######################F######", "#####C###########G###########C######", "#####F##########H#H##########F######", "######F#####################F#######", "#######C###################C########", "########F#################F#########", "#########F###############F##########", "##########F#############F###########", "###########F###########F############", "############F#########F#############", "#############F#######F##############", "##############FFFFFFF###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "##############FFFFFFF###############", "#############F#######F##############", "############F#########F#############", "###########F###########F############", "##########F#############F###########", "#########F###############F##########", "########F#################F#########", "#######F###################F########", "######C#####################C#######", "#####F#######################F######", "####F#########################F#####", "####C############G############C#####", "####F###########H#H###########F#####", "#####F#######################F######", "######C#####################C#######", "#######F###################F########", "########F#################F#########", "#########F###############F##########", "##########F#############F###########", "###########F###########F############", "############F#########F#############", "#############F#######F##############", "##############FFFFFFF###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "#############F###B###F##############", "############F####B####F#############", "###########F#####B#####F############", "##########F######B######F###########", "#########F#######B#######F##########", "########F########B########F#########", "#######F#########B#########F########", "######F##########B##########F#######", "#####C###########B###########C######", "####F############B############F#####", "###F#############B#############F####", "###C#############E#############C####", "###F############H#H############F####", "####F#########################F#####", "#####C#######################C######", "######F#####################F#######", "#######F###################F########", "########F#################F#########", "#########F###############F##########", "##########F#############F###########", "###########F###########F############", "############F#########F#############", "#############F#######F##############", "##############FFHEHFF###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("#############IJJJJJJJI##############", "#############I#######I##############", "#############I#######I##############", "#############I#######I##############", "#############I#######I##############", "#############I#######I##############", "#############I#######I##############", "#############I#######I##############", "############F#########F#############", "###########F###########F############", "##########F#############F###########", "#########F###############F##########", "########F#################F#########", "#######F###################F########", "######F#####################F#######", "#####F#######################F######", "####C#########################C#####", "###F###########################F####", "##F#############################F###", "##C#############FKF#############C###", "##F############H###H############F###", "###F###########################F####", "####C#########################C#####", "#####F#######################F######", "######F#####################F#######", "#######F###################F########", "########F#################F#########", "#########F###############F##########", "##########F#############F###########", "###########F###########F############", "############F#########F#############", "#############FEH###HEF##############", "################EEE#################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("############IJJJJJJJJJI#############", "############I#########I#############", "############I#########I#############", "############I#########I#############", "############I#########I#############", "############I#########I#############", "############I#########I#############", "############I#########I#############", "###########F###########F############", "##########F#############F###########", "#########F###############F##########", "########F#################F#########", "#######F###################F########", "######F#####################F#######", "#####F#######################F######", "####F#########################F#####", "###C###########################C####", "##F#############################F###", "#F###############################F##", "#C#############F#K#F#############C##", "#F############H#####H############F##", "##F#############################F###", "###C###########################C####", "####F#########################F#####", "#####F#######################F######", "######F#####################F#######", "#######F###################F########", "########F#################F#########", "#########F###############F##########", "##########F#############F###########", "###########F###########F############", "############FEH#####HEF#############", "###############E###E################", "################HHH#################", "###############EBBBE################", "###############DBBBD################", "###############EBBBE################", "###############DBBBD################", "###############EBBBE################", "###############DBBBD################", "###############EBBBE################")
                .aisle("B####B#####IJJJJJJJJJJJI#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B####F#############F####B####B#", "B####B###F###############F###B####B#", "B####B##F#################F##B####B#", "B####B#F###################F#B####B#", "B####BF#####################FB####B#", "B####F#######################F####B#", "B###F#########################F###B#", "B##F###########################F##B#", "B#C#############################C#B#", "BF###############################FB#", "B#################################B#", "B#############F##K##F#############B#", "B############H#######H############B#", "#F###############################F##", "##C#############################C###", "###F###########################F####", "####F#########################F#####", "#####F#######################F######", "######F#####################F#######", "#######F###################F########", "########F#################F#########", "#########F###############F##########", "##########F#############F###########", "###########FEH#######HEF############", "##############E#####E###############", "###############HLLLH################", "##############E#####E###############", "##############D#####D###############", "##############E#####E###############", "##############D#####D###############", "##############E#####E###############", "##############D#####D###############", "##############E#####E###############")
                .aisle("##########BJJJJJJJJJJJJJB###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "#########F####K#####K####F##########", "########F#####K#####K#####F#########", "#######F######K#####K######F########", "######F#####################F#######", "#####F#######################F######", "####F#########################F#####", "###F###########################F####", "##F#############################F###", "#C###############################C##", "C#################################C#", "###################################C", "#############F###K###F#############C", "############H#########H############C", "C#################################C#", "#C###############################C##", "##F#############################F###", "###F###########################F####", "####F#########################F#####", "#####F#######################F######", "######F#####################F#######", "#######F###################F########", "########F#################F#########", "#########F###############F##########", "##########FEH#########HEF###########", "#############E#######E##############", "##############JJJJJJJ###############", "#############E#######E##############", "#############D#######D##############", "#############E#######E##############", "#############D#######D##############", "#############E#######E##############", "#############D#######D##############", "#############E#######E##############")
                .aisle("##########BJJJJJJJJJJJJJB###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "#########F#####K###K#####F##########", "########F######K###K######F#########", "#######F#######K###K#######F########", "######F########K###K########F#######", "#####F#########K###K#########F######", "####F##########K###K##########F#####", "###F###########################F####", "##F#############################F###", "#C###############################C##", "D#################################D#", "###################################D", "############F####K####F############D", "###########H###########H###########D", "D#################################D#", "#C###############################C##", "##F#############################F###", "###F###########################F####", "####F#########################F#####", "#####F#######################F######", "######F#####################F#######", "#######F###################F########", "########F#################F#########", "#########F###############F##########", "##########FH###########HF###########", "############E#########E#############", "#############FJJJJJJJH##############", "############E#########E#############", "############D#########D#############", "############E#########E#############", "############D#########D#############", "############E#########E#############", "############D#########D#############", "############E#########E#############")
                .aisle("##########BJJJJJJJJJJJJJB###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "#########F######K#K######F##########", "########F#######K#K#######F#########", "#######F########K#K########F########", "######F#########K#K#########F#######", "#####F##########K#K##########F######", "####F###########K#K###########F#####", "###F############K#K############F####", "##F#############K#K#############F###", "#C##############K#K##############C##", "D###############K#K###############D#", "################K#K################C", "###########F####EKE####F###########C", "HHHHHHHHHHH#####G#G#####HHHHHHHHHHHC", "D###############G#G###############D#", "#C##############G#G##############C##", "##F#############G#G#############F###", "###F############G#G############F####", "####F###########G#G###########F#####", "#####F##########G#G##########F######", "######F#########G#G#########F#######", "#######F########G#G########F########", "########F#######G#G#######F#########", "#########F######G#G######F##########", "##########H#####G#G#####H###########", "###########E####G#G####E############", "############HLJJJJJJJLH#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############")
                .aisle("##########BJJJJJJJJJJJJJB###########", "##########B######K######B###########", "##########B######K######B###########", "##########B######K######B###########", "##########B######K######B###########", "##########B######K######B###########", "##########B######K######B###########", "##########B######K######B###########", "#########FB######K######BF##########", "########F#B######K######B#F#########", "#######F##B######K######B##F########", "######F###B######K######B###F#######", "#####F####B######K######B####F######", "####F#####B######K######B#####F#####", "###F######B######K######B######F####", "##F#######B######K######B#######F###", "#C########B######K######B########C##", "D#########B######K######B#########D#", "##########B######K######B##########C", "GGGGGGGGGGEKKKKKKEKKKKKKEGGGGGGGGGGE", "#################G#################C", "D################G################D#", "#C###############G###############C##", "##F##############G##############F###", "###F#############G#############F####", "####F############G############F#####", "#####F###########G###########F######", "######F##########G##########F#######", "#######F#########G#########F########", "########F########G########F#########", "#########F#######G#######F##########", "##########E######G######E###########", "###########E#####G#####E############", "############HLJJJJJJJLH#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############")
                .aisle("##########BJJJJJJJJJJJJJB###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "##########B#####K#K#####B###########", "#########F######K#K######F##########", "########F#######K#K#######F#########", "#######F########K#K########F########", "######F#########K#K#########F#######", "#####F##########K#K##########F######", "####F###########K#K###########F#####", "###F############K#K############F####", "##F#############K#K#############F###", "#C##############K#K##############C##", "D###############K#K###############D#", "################K#K################C", "###########F####EKE####F###########C", "HHHHHHHHHHH#####G#G#####HHHHHHHHHHHC", "D###############G#G###############D#", "#C##############G#G##############C##", "##F#############G#G#############F###", "###F############G#G############F####", "####F###########G#G###########F#####", "#####F##########G#G##########F######", "######F#########G#G#########F#######", "#######F########G#G########F########", "########F#######G#G#######F#########", "#########F######G#G######F##########", "##########H#####G#G#####H###########", "###########E####G#G####E############", "############HLJJJJJJJLH#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############", "############B#########B#############")
                .aisle("##########BJJJJJJJJJJJJJB###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "##########B####K###K####B###########", "#########F#####K###K#####F##########", "########F######K###K######F#########", "#######F#######K###K#######F########", "######F########K###K########F#######", "#####F#########K###K#########F######", "####F##########K###K##########F#####", "###F###########################F####", "##F#############################F###", "#C###############################C##", "D#################################D#", "###################################D", "############F####K####F############D", "###########H###########H###########D", "D#################################D#", "#C###############################C##", "##F#############################F###", "###F###########################F####", "####F#########################F#####", "#####F#######################F######", "######F#####################F#######", "#######F###################F########", "########F#################F#########", "#########F###############F##########", "##########FH###########HF###########", "############E#########E#############", "#############HJJJJJJJH##############", "############E#########E#############", "############D#########D#############", "############E#########E#############", "############D#########D#############", "############E#########E#############", "############D#########D#############", "############E#########E#############")
                .aisle("##########BJJJJJJJJJJJJJB###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "##########B###K#####K###B###########", "#########F####K#####K####F##########", "########F#####K#####K#####F#########", "#######F######K#####K######F########", "######F#####################F#######", "#####F#######################F######", "####F#########################F#####", "###F###########################F####", "##F#############################F###", "#C###############################C##", "C#################################C#", "###################################C", "#############F###K###F#############C", "############H#########H############C", "C#################################C#", "#C###############################C##", "##F#############################F###", "###F###########################F####", "####F#########################F#####", "#####F#######################F######", "######F#####################F#######", "#######F###################F########", "########F#################F#########", "#########F###############F##########", "##########FEH#########HEF###########", "#############E#######E##############", "##############JJJJJJJ###############", "#############E#######E##############", "#############D#######D##############", "#############E#######E##############", "#############D#######D##############", "#############E#######E##############", "#############D#######D##############", "#############E#######E##############")
                .aisle("B####B#####IJJJJJJJJJJJI#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B#####I#K#######K#I#####B####B#", "B####B####FL###########LF####B####B#", "B####B###FLL###########LLF###B####B#", "B####B##FLLL###########LLLF##B####B#", "B####B#FLLLL###########LLLLF#B####B#", "B####BFLLLLL###########LLLLLFB####B#", "B####FLLLLLL###########LLLLLLF####B#", "B###FLLLLLLL###########LLLLLLLF###B#", "B##FLLLLLLLL###########LLLLLLLLF##B#", "B#FLLLLLLLLL###########LLLLLLLLLF#B#", "BFLLLLLLLLLL###########LLLLLLLLLLFB#", "BLLLLLLLLLLL###########LLLLLLLLLLLB#", "BLLLLLLLLLLL##F##K##F##LLLLLLLLLLLB#", "BLLLLLLLLLLL#H#######H#LLLLLLLLLLLB#", "#FLLLLLLLLLL###########LLLLLLLLLLF##", "##FLLLLLLLLL###########LLLLLLLLLF###", "###FLLLLLLLL###########LLLLLLLLF####", "####FLLLLLLL###########LLLLLLLF#####", "#####FLLLLLL###########LLLLLLF######", "######FLLLLL###########LLLLLF#######", "#######FLLLL###########LLLLF########", "########FLLL###########LLLF#########", "#########FLL###########LLF##########", "##########FL###########LF###########", "###########FEH#######HEF############", "##############E#####E###############", "###############HLLLH################", "##############E#####E###############", "##############D#####D###############", "##############E#####E###############", "##############D#####D###############", "##############E#####E###############", "##############D#####D###############", "##############E#####E###############")
                .aisle("############IJJJJJJJJJI#############", "############I#########I#############", "############I#########I#############", "############I#########I#############", "############I#########I#############", "############I#########I#############", "############I#########I#############", "############I#########I#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L##F#K#F##L#############", "############L#H#####H#L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############L#########L#############", "############LEH#####HEL#############", "###############E###E################", "################HHH#################", "###############EBBBE################", "###############DBBBD################", "###############EBBBE################", "###############DBBBD################", "###############EBBBE################", "###############DBBBD################", "###############EBBBE################")
                .aisle("#############IJJJJJJJI##############", "#############I#######I##############", "#############I#######I##############", "#############I#######I##############", "#############I#######I##############", "#############I#######I##############", "#############I#######I##############", "#############I#######I##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L##FKF##L##############", "#############L#H###H#L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############L#######L##############", "#############LEH###HEL##############", "################EEE#################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################")
                .aisle("##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBB@BBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBBBBBB###############", "##############BBHHHBB###############", "##############LLLLLLL###############", "##############LLLLLLL###############", "##############LLLLLLL###############", "##############LLLLLLL###############", "##############LLLLLLL###############", "##############LLLLLLL###############", "##############LLLLLLL###############", "##############LLLLLLL###############", "##############LLLLLLL###############", "##############LLLLLLL###############", "##############LLHHHLL###############", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "####################################", "###################################A")
                .where('A', Predicates.any())
                .where('#', Predicates.any())
                .where('B', tcpatch$ctnhPredicates("SpaceStructuralFrameworkBlock")
                        .or(Predicates.abilities(PartAbility.OUTPUT_ENERGY))
                        .or(Predicates.abilities(PartAbility.SUBSTATION_OUTPUT_ENERGY))
                        .or(Predicates.abilities(PartAbility.OUTPUT_LASER))
                        .or(Predicates.abilities(PartAbility.IMPORT_ITEMS))
                        .or(Predicates.abilities(PartAbility.EXPORT_ITEMS))
                        .or(Predicates.abilities(PartAbility.EXPORT_FLUIDS))
                        .or(Predicates.abilities(PartAbility.IMPORT_FLUIDS)))
                .where('C', Predicates.blocks(tcpatch$requiredBlock(ResourceLocation.tryBuild("ctnhcore", "pv_coil"))))
                .where('D', Predicates.blocks(GTBlocks.FUSION_CASING.get()))
                .where('E', Predicates.blocks(GTBlocks.HIGH_POWER_CASING.get()))
                .where('F', Predicates.blocks(tcpatch$requiredBlock(ResourceLocation.tryBuild("ctnhcore", "stellar_radiation_router_casing"))))
                .where('G', Predicates.blocks(GTBlocks.SUPERCONDUCTING_COIL.get()))
                .where('H', Predicates.blocks(GTBlocks.MACHINE_CASING_LuV.get()))
                .where('I', Predicates.blocks(GTBlocks.HERMETIC_CASING_ZPM.get()))
                .where('J', tcpatch$ctnhPredicates("PhotovoltaicBlock"))
                .where('K', Predicates.blocks(GTBlocks.COIL_NAQUADAH.get()))
                .where('L', Predicates.blocks(GTBlocks.FUSION_GLASS.get()))
                .where('@', Predicates.controller(Predicates.blocks(definition.get())))
                .build()));

        // Avoid stale previews: force matching shapes to be generated from patternFactory.
        definition.setShapes(java.util.List::of);
    }

    @Unique
    private static TraceabilityPredicate tcpatch$ctnhPredicates(String methodName) {
        try {
            Class<?> clazz = Class.forName("io.github.cpearl0.ctnhcore.api.Pattern.CTNHPredicates");
            var method = clazz.getDeclaredMethod(methodName);
            Object result = method.invoke(null);
            return (TraceabilityPredicate) result;
        } catch (Throwable t) {
            throw new RuntimeException("Failed to call CTNHPredicates#" + methodName + "()", t);
        }
    }

    @Unique
    private static Block tcpatch$requiredBlock(ResourceLocation id) {
        Block block = ForgeRegistries.BLOCKS.getValue(id);
        if (block == null || block == Blocks.AIR) {
            throw new IllegalStateException("Missing required block in registry: " + id);
        }
        return block;
    }
}
